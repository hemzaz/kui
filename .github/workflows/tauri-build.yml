# Tauri Build Pipeline
#
# This workflow builds Kui with Tauri for all supported platforms:
# - macOS (Intel x64 + Apple Silicon ARM64)
# - Linux (x64)
# - Windows (x64)
#
# Features:
# - Multi-platform build matrix with fail-fast disabled for complete coverage
# - Intelligent caching of npm, Rust, and Tauri dependencies
# - Parallel builds across platforms for speed
# - Automated artifact uploads for distribution
# - Post-build test validation
# - Platform-specific dependency installation
#
# Build Artifacts:
# - macOS: DMG installer in src-tauri/target/release/bundle/dmg/
# - Linux: DEB, AppImage in src-tauri/target/release/bundle/
# - Windows: MSI, NSIS installer in src-tauri/target/release/bundle/

name: Tauri Build

on:
  push:
    branches: [master, main, develop]
    paths:
      - 'src-tauri/**'
      - 'packages/**'
      - 'plugins/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/tauri-build.yml'
  pull_request:
    branches: [master, main]
  workflow_dispatch: # Allow manual triggers

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Build configuration
  BUILD_ENV: production
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  # Node.js version aligned with package.json engines requirement
  NODE_VERSION: '24'

jobs:
  # =============================================================================
  # BUILD JOB: Multi-platform Tauri application builds
  # =============================================================================
  build-tauri:
    name: Build Tauri - ${{ matrix.platform }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}

    strategy:
      # Don't cancel all builds if one fails - we want to see all platform results
      fail-fast: false
      matrix:
        include:
          # macOS Intel (x64)
          - platform: macos
            arch: x64
            os: macos-latest
            rust_target: x86_64-apple-darwin
            tauri_args: --target x86_64-apple-darwin

          # macOS Apple Silicon (ARM64)
          - platform: macos
            arch: arm64
            os: macos-latest
            rust_target: aarch64-apple-darwin
            tauri_args: --target aarch64-apple-darwin

          # Linux x64
          - platform: linux
            arch: x64
            os: ubuntu-20.04
            rust_target: x86_64-unknown-linux-gnu
            tauri_args: ''

          # Windows x64
          - platform: windows
            arch: x64
            os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            tauri_args: ''

    steps:
      # -------------------------------------------------------------------------
      # STEP 1: Checkout repository
      # -------------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------------------
      # STEP 2: Setup Node.js with caching
      # -------------------------------------------------------------------------
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Cache npm dependencies for faster subsequent builds
          cache: 'npm'

      # -------------------------------------------------------------------------
      # STEP 3: Setup Rust toolchain with caching
      # -------------------------------------------------------------------------
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          # Install the target triple for cross-compilation (macOS ARM)
          targets: ${{ matrix.rust_target }}

      # -------------------------------------------------------------------------
      # STEP 4: Cache Rust dependencies (Cargo registry, git checkouts, build)
      # This dramatically speeds up Rust compilation on subsequent runs
      # -------------------------------------------------------------------------
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          # Include the target in the cache key for platform-specific caching
          key: ${{ matrix.platform }}-${{ matrix.arch }}

      # -------------------------------------------------------------------------
      # STEP 5: Install platform-specific system dependencies
      # -------------------------------------------------------------------------

      # Linux: Install GTK3, WebKit2GTK, and other required libraries
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libwayland-dev \
            libwayland-client0 \
            libwayland-server0 \
            libxkbcommon-dev \
            wayland-protocols \
            xwayland

      # macOS: Install target for cross-compilation if needed
      - name: Install macOS cross-compilation target
        if: matrix.platform == 'macos'
        run: rustup target add ${{ matrix.rust_target }}

      # -------------------------------------------------------------------------
      # STEP 6: Install npm dependencies
      # Uses npm ci for clean, reproducible installs based on package-lock.json
      # -------------------------------------------------------------------------
      - name: Install npm dependencies
        run: npm ci
        env:
          # Prevent optional dependencies from failing the build
          npm_config_optional: false

      # -------------------------------------------------------------------------
      # STEP 7: Build TypeScript and prepare assets
      # This runs before the Tauri build as configured in tauri.conf.json
      # -------------------------------------------------------------------------
      - name: Build frontend assets
        run: npm run compile
        env:
          NODE_ENV: production

      # -------------------------------------------------------------------------
      # STEP 8: Build Tauri application
      # This is the main build step that creates the platform-specific bundles
      # -------------------------------------------------------------------------
      - name: Build Tauri app
        run: npm run tauri:build -- ${{ matrix.tauri_args }}
        env:
          # Tauri build environment
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      # -------------------------------------------------------------------------
      # STEP 9: Prepare artifacts for upload
      # Different platforms create bundles in different formats and locations
      # -------------------------------------------------------------------------

      # macOS: DMG files
      - name: Prepare macOS artifacts
        if: matrix.platform == 'macos'
        run: |
          mkdir -p artifacts
          find src-tauri/target/${{ matrix.rust_target }}/release/bundle/dmg -name "*.dmg" -exec cp {} artifacts/ \;
          ls -lah artifacts/

      # Linux: DEB and AppImage files
      - name: Prepare Linux artifacts
        if: matrix.platform == 'linux'
        run: |
          mkdir -p artifacts
          find src-tauri/target/release/bundle/deb -name "*.deb" -exec cp {} artifacts/ \; 2>/dev/null || true
          find src-tauri/target/release/bundle/appimage -name "*.AppImage" -exec cp {} artifacts/ \; 2>/dev/null || true
          ls -lah artifacts/

      # Windows: MSI and NSIS installers
      - name: Prepare Windows artifacts
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts
          Get-ChildItem -Path "src-tauri\target\release\bundle\msi" -Filter "*.msi" -Recurse | Copy-Item -Destination artifacts\ -ErrorAction SilentlyContinue
          Get-ChildItem -Path "src-tauri\target\release\bundle\nsis" -Filter "*.exe" -Recurse | Copy-Item -Destination artifacts\ -ErrorAction SilentlyContinue
          Get-ChildItem -Path artifacts

      # -------------------------------------------------------------------------
      # STEP 10: Upload build artifacts
      # Makes installers available for download from GitHub Actions UI
      # -------------------------------------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kui-tauri-${{ matrix.platform }}-${{ matrix.arch }}
          path: artifacts/*
          # Keep artifacts for 30 days
          retention-days: 30
          # Fail if no files are found
          if-no-files-found: error

      # -------------------------------------------------------------------------
      # STEP 11: Display build summary
      # -------------------------------------------------------------------------
      - name: Build summary
        run: |
          echo "### Build completed successfully! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** ${{ matrix.arch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rust Target:** ${{ matrix.rust_target }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build artifacts have been uploaded and are available for download." >> $GITHUB_STEP_SUMMARY
        shell: bash

  # =============================================================================
  # TEST JOB: Validate builds with automated tests
  # Runs after all builds complete to validate core functionality
  # =============================================================================
  test-tauri:
    name: Test Tauri Build
    needs: build-tauri
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------------------------
      # STEP 1: Checkout repository
      # -------------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------------------
      # STEP 2: Setup Node.js with caching
      # -------------------------------------------------------------------------
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # -------------------------------------------------------------------------
      # STEP 3: Install system dependencies for testing
      # -------------------------------------------------------------------------
      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwayland-dev \
            libwayland-client0 \
            libwayland-server0 \
            weston \
            xwayland \
            libxkbcommon-dev

      # -------------------------------------------------------------------------
      # STEP 4: Install npm dependencies
      # -------------------------------------------------------------------------
      - name: Install npm dependencies
        run: npm ci

      # -------------------------------------------------------------------------
      # STEP 5: Run test suite
      # Using the browser target for CI testing
      # -------------------------------------------------------------------------
      - name: Run tests
        run: npm run test:browser
        env:
          CI: true
          MOCHA_RUN_TARGET: webpack
          KUI_USE_PROXY: true

      # -------------------------------------------------------------------------
      # STEP 6: Test summary
      # -------------------------------------------------------------------------
      - name: Test summary
        if: always()
        run: |
          echo "### Test Results :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo ":white_check_mark: All tests passed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Some tests failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

  # =============================================================================
  # RELEASE JOB: Create GitHub release with all artifacts (optional)
  # Only runs on tagged commits (e.g., v13.1.0)
  # =============================================================================
  release:
    name: Create Release
    needs: [build-tauri, test-tauri]
    runs-on: ubuntu-latest
    # Only run on version tags
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      # -------------------------------------------------------------------------
      # STEP 1: Checkout repository
      # -------------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------------------
      # STEP 2: Download all build artifacts
      # -------------------------------------------------------------------------
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      # -------------------------------------------------------------------------
      # STEP 3: Display downloaded artifacts
      # -------------------------------------------------------------------------
      - name: Display structure of downloaded files
        run: ls -R release-artifacts

      # -------------------------------------------------------------------------
      # STEP 4: Create GitHub Release
      # -------------------------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-artifacts/**/*
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------------------------------------------------
      # STEP 5: Release summary
      # -------------------------------------------------------------------------
      - name: Release summary
        run: |
          echo "### Release Created :package:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A draft release has been created with all platform binaries." >> $GITHUB_STEP_SUMMARY
          echo "Review the release notes and publish when ready." >> $GITHUB_STEP_SUMMARY
