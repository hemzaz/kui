# Tauri Release Pipeline
#
# Automated release workflow for Kui with Tauri
#
# This workflow handles the complete release process:
# - Version bumping and tagging
# - Multi-platform builds with signing
# - Automated testing and validation
# - GitHub Release creation with release notes
# - Auto-update manifest generation
# - Distribution channel updates (Homebrew, etc.)
#
# Triggered by:
# - Manual workflow dispatch with version selection
# - Tag pushes matching v*.*.*
#
# Release Types:
# - alpha: v13.1.0-alpha.1 (pre-release, frequent updates)
# - beta: v13.1.0-beta.1 (pre-release, weekly updates)
# - rc: v13.1.0-rc.1 (release candidate, final testing)
# - stable: v13.1.0 (production release)

name: Tauri Release

on:
  # Manual trigger with version selection
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 13.1.0, 13.1.0-beta.1)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - alpha
          - beta
          - rc
          - stable
      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: true
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'Skip test suite (not recommended)'
        required: false
        type: boolean
        default: false

  # Automatic trigger on version tags
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-alpha.*'
      - 'v*.*.*-beta.*'
      - 'v*.*.*-rc.*'

# Only allow one release workflow at a time
concurrency:
  group: release
  cancel-in-progress: false

env:
  NODE_VERSION: '24'
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # =============================================================================
  # VALIDATE: Pre-release validation checks
  # =============================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      release_type: ${{ steps.version.outputs.release_type }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          else
            # Extract from tag
            VERSION="${GITHUB_REF#refs/tags/v}"
            if [[ "$VERSION" =~ -alpha ]]; then
              RELEASE_TYPE="alpha"
            elif [[ "$VERSION" =~ -beta ]]; then
              RELEASE_TYPE="beta"
            elif [[ "$VERSION" =~ -rc ]]; then
              RELEASE_TYPE="rc"
            else
              RELEASE_TYPE="stable"
            fi
          fi

          # Determine if pre-release
          IS_PRERELEASE="false"
          if [[ "$VERSION" =~ -(alpha|beta|rc) ]]; then
            IS_PRERELEASE="true"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          echo "### Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: $RELEASE_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: $IS_PRERELEASE" >> $GITHUB_STEP_SUMMARY

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-z]+\.[0-9]+)?$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected: X.Y.Z or X.Y.Z-type.N"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Error: Tag v$VERSION already exists"
            exit 1
          fi

      - name: Verify changelog entry
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! grep -q "## \[$VERSION\]" CHANGELOG.md 2>/dev/null; then
            echo "Warning: No changelog entry found for $VERSION"
            echo "Consider adding release notes to CHANGELOG.md"
          fi

  # =============================================================================
  # TEST: Run comprehensive test suite
  # =============================================================================
  test:
    name: Pre-Release Tests
    needs: validate
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libwayland-dev \
            libxkbcommon-dev

      - name: Install npm dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run compile

      - name: Run unit tests
        run: npm run test:tauri:unit
        continue-on-error: true

      - name: Run integration tests
        run: npm run test:tauri:integration
        timeout-minutes: 15

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # =============================================================================
  # BUILD: Multi-platform release builds
  # =============================================================================
  build-release:
    name: Build Release - ${{ matrix.platform }}
    needs: [validate, test]
    if: always() && needs.validate.result == 'success' && (needs.test.result == 'success' || inputs.skip_tests)
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-x64
            os: macos-latest
            rust_target: x86_64-apple-darwin
            tauri_args: --target x86_64-apple-darwin

          - platform: macos-arm64
            os: macos-latest
            rust_target: aarch64-apple-darwin
            tauri_args: --target aarch64-apple-darwin

          - platform: linux-x64
            os: ubuntu-20.04
            rust_target: x86_64-unknown-linux-gnu
            tauri_args: ''

          - platform: windows-x64
            os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            tauri_args: ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          key: release-${{ matrix.platform }}

      # Platform-specific dependencies
      - name: Install Linux dependencies
        if: matrix.platform == 'linux-x64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libwayland-dev \
            libxkbcommon-dev \
            wayland-protocols

      - name: Install macOS target
        if: startsWith(matrix.platform, 'macos')
        run: rustup target add ${{ matrix.rust_target }}

      # Update version in project files
      - name: Update version in package.json
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          npm version $VERSION --no-git-tag-version --allow-same-version

      - name: Update version in tauri.conf.json
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          cd src-tauri
          sed -i.bak "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" tauri.conf.json
          rm tauri.conf.json.bak
        shell: bash

      - name: Update version in Cargo.toml
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          cd src-tauri
          sed -i.bak "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
          rm Cargo.toml.bak
        shell: bash

      - name: Install dependencies
        run: npm ci
        env:
          npm_config_optional: false

      - name: Build frontend
        run: npm run compile
        env:
          NODE_ENV: production

      # Build with code signing
      - name: Build Tauri app (with signing)
        run: npm run tauri:build -- ${{ matrix.tauri_args }}
        env:
          # Code signing secrets
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          # macOS signing
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Windows signing
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}

      # Prepare artifacts with version in filename
      - name: Prepare artifacts (macOS)
        if: startsWith(matrix.platform, 'macos')
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p release-artifacts
          find src-tauri/target/${{ matrix.rust_target }}/release/bundle/dmg -name "*.dmg" -exec cp {} release-artifacts/Kui-${VERSION}-${{ matrix.platform }}.dmg \;
          ls -lah release-artifacts/

      - name: Prepare artifacts (Linux)
        if: matrix.platform == 'linux-x64'
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p release-artifacts
          find src-tauri/target/release/bundle/deb -name "*.deb" -exec cp {} release-artifacts/Kui-${VERSION}-linux-x64.deb \; 2>/dev/null || true
          find src-tauri/target/release/bundle/appimage -name "*.AppImage" -exec cp {} release-artifacts/Kui-${VERSION}-linux-x64.AppImage \; 2>/dev/null || true
          ls -lah release-artifacts/

      - name: Prepare artifacts (Windows)
        if: matrix.platform == 'windows-x64'
        shell: pwsh
        run: |
          $VERSION = "${{ needs.validate.outputs.version }}"
          New-Item -ItemType Directory -Force -Path release-artifacts
          Get-ChildItem -Path "src-tauri\target\release\bundle\msi" -Filter "*.msi" -Recurse | ForEach-Object {
            Copy-Item $_.FullName -Destination "release-artifacts\Kui-$VERSION-windows-x64.msi"
          }
          Get-ChildItem -Path "release-artifacts"

      # Generate checksums
      - name: Generate checksums
        run: |
          cd release-artifacts
          if command -v sha256sum &> /dev/null; then
            sha256sum * > SHA256SUMS.txt
          else
            shasum -a 256 * > SHA256SUMS.txt
          fi
          cat SHA256SUMS.txt
        shell: bash

      # Upload artifacts
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}
          path: release-artifacts/*
          retention-days: 7
          if-no-files-found: error

  # =============================================================================
  # RELEASE: Create GitHub release with all artifacts
  # =============================================================================
  create-release:
    name: Create GitHub Release
    needs: [validate, build-release]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          pattern: release-*
          merge-multiple: false

      - name: Organize artifacts
        run: |
          mkdir -p release-files
          find all-artifacts -type f -exec cp {} release-files/ \;
          ls -lah release-files/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          RELEASE_TYPE="${{ needs.validate.outputs.release_type }}"

          # Create release notes
          cat > release-notes.md << 'EOF'
          # Kui $VERSION - Tauri Edition

          ## What's New in This Release

          EOF

          # Extract changelog for this version
          if grep -q "## \[$VERSION\]" CHANGELOG.md 2>/dev/null; then
            sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | head -n -1 >> release-notes.md
          else
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release-notes.md
          fi

          # Add platform-specific notes
          cat >> release-notes.md << 'EOF'

          ## Installation

          ### macOS
          - **Intel (x64)**: Download `Kui-$VERSION-macos-x64.dmg`
          - **Apple Silicon (ARM64)**: Download `Kui-$VERSION-macos-arm64.dmg`

          ```bash
          # Via Homebrew
          brew install kui
          ```

          ### Linux
          - **DEB Package**: Download `Kui-$VERSION-linux-x64.deb`
          - **AppImage**: Download `Kui-$VERSION-linux-x64.AppImage`

          ```bash
          # Debian/Ubuntu
          sudo apt install ./Kui-$VERSION-linux-x64.deb

          # AppImage
          chmod +x Kui-$VERSION-linux-x64.AppImage
          ./Kui-$VERSION-linux-x64.AppImage
          ```

          ### Windows
          - **MSI Installer**: Download `Kui-$VERSION-windows-x64.msi`

          ```powershell
          # Via Chocolatey
          choco install kui
          ```

          ## Performance

          - **10x smaller**: ~15 MB vs ~150 MB (Electron)
          - **4x faster startup**: ~0.5s vs ~2s
          - **50% less memory**: ~80 MB vs ~150 MB

          ## Security

          All releases are signed and checksums are provided in `SHA256SUMS.txt`.

          ## Documentation

          - [Migration Guide](docs/MIGRATING_TO_TAURI.md)
          - [Technical Details](TAURI_MIGRATION.md)
          - [Deployment Plan](TAURI_DEPLOYMENT_PLAN.md)

          ## Support

          - Report issues: https://github.com/IBM/kui/issues
          - Discussions: https://github.com/IBM/kui/discussions
          - Documentation: https://github.com/IBM/kui/tree/master/docs
          EOF

          # Replace $VERSION placeholder
          sed -i "s/\$VERSION/$VERSION/g" release-notes.md

          echo "Release notes generated:"
          cat release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: Kui v${{ needs.validate.outputs.version }}
          body_path: release-notes.md
          files: release-files/*
          draft: ${{ github.event.inputs.draft || 'true' }}
          prerelease: ${{ needs.validate.outputs.is_prerelease }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate auto-update manifest
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          # Create update manifest for Tauri updater
          cat > update-manifest.json << EOF
          {
            "version": "$VERSION",
            "notes": "See release notes at https://github.com/IBM/kui/releases/tag/v$VERSION",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "darwin-x86_64": {
                "signature": "",
                "url": "https://github.com/IBM/kui/releases/download/v$VERSION/Kui-$VERSION-macos-x64.dmg"
              },
              "darwin-aarch64": {
                "signature": "",
                "url": "https://github.com/IBM/kui/releases/download/v$VERSION/Kui-$VERSION-macos-arm64.dmg"
              },
              "linux-x86_64": {
                "signature": "",
                "url": "https://github.com/IBM/kui/releases/download/v$VERSION/Kui-$VERSION-linux-x64.AppImage"
              },
              "windows-x86_64": {
                "signature": "",
                "url": "https://github.com/IBM/kui/releases/download/v$VERSION/Kui-$VERSION-windows-x64.msi"
              }
            }
          }
          EOF

          echo "Auto-update manifest generated:"
          cat update-manifest.json

      - name: Upload update manifest
        uses: actions/upload-artifact@v4
        with:
          name: update-manifest
          path: update-manifest.json
          retention-days: 90

      - name: Release summary
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          RELEASE_TYPE="${{ needs.validate.outputs.release_type }}"

          echo "## Release Created Successfully! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Type**: $RELEASE_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release**: ${{ needs.validate.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Links" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/IBM/kui/releases/tag/v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Review release notes" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Test downloads on each platform" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Publish release (if draft)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Announce on social media" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Update Homebrew formula (if stable)" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # POST-RELEASE: Update distribution channels
  # =============================================================================
  update-distributions:
    name: Update Distribution Channels
    needs: [validate, create-release]
    runs-on: ubuntu-latest
    if: needs.validate.outputs.release_type == 'stable'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update Homebrew formula
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "TODO: Implement Homebrew formula update"
          echo "This would typically:"
          echo "1. Fork homebrew-core"
          echo "2. Update kui.rb formula with new version and checksums"
          echo "3. Create PR to homebrew-core"

          # Placeholder for actual implementation
          echo "Homebrew update for version $VERSION"

      - name: Notify package maintainers
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "TODO: Notify package maintainers"
          echo "- Debian/Ubuntu: Create issue for package update"
          echo "- Fedora: Create issue for package update"
          echo "- AUR: Update PKGBUILD"
          echo "- Chocolatey: Update package"
          echo "- Winget: Update manifest"

      - name: Post-release summary
        run: |
          echo "## Distribution Updates Initiated :package:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Manual follow-up required for:" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Homebrew formula update" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Debian/Ubuntu packages" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Fedora packages" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] AUR package" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Chocolatey package" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Winget manifest" >> $GITHUB_STEP_SUMMARY
