# Tauri Testing Pipeline
#
# This workflow runs automated tests for the Tauri-based Kui application across
# all supported platforms to ensure quality and catch regressions early.
#
# Test Coverage:
# - Unit tests (Rust + TypeScript)
# - Integration tests (IPC, window management)
# - Feature parity tests (Tauri vs browser)
# - Platform-specific tests (macOS, Linux, Windows)
# - Performance benchmarks
#
# Triggers:
# - Every push to main branches
# - Pull requests
# - Manual dispatch for ad-hoc testing
#
# This workflow complements tauri-build.yml by focusing exclusively on testing
# without building production artifacts, enabling faster feedback cycles.

name: Tauri Tests

on:
  push:
    branches: [master, main, develop]
    paths:
      - 'src-tauri/**'
      - 'packages/**'
      - 'plugins/**'
      - 'tests/**'
      - 'package.json'
      - 'Cargo.toml'
      - '.github/workflows/tauri-test.yml'
  pull_request:
    branches: [master, main]
  workflow_dispatch: # Allow manual triggers
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - e2e
          - performance

# Cancel in-progress test runs when a new run is triggered on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Node.js version aligned with package.json engines requirement
  NODE_VERSION: '24'
  # Rust configuration
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  # Test configuration
  CI: true
  RUNNING_KUI_TEST: true

jobs:
  # =============================================================================
  # RUST QUALITY: Linting, formatting, and static analysis
  # =============================================================================
  rust-quality:
    name: Rust Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Check Rust formatting
        working-directory: src-tauri
        run: cargo fmt --all -- --check

      - name: Run Clippy (Rust linter)
        working-directory: src-tauri
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Check for security vulnerabilities
        working-directory: src-tauri
        run: |
          cargo install cargo-audit --quiet
          cargo audit

      - name: Quality check summary
        if: always()
        run: |
          echo "### Rust Quality Checks :mag:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo ":white_check_mark: All quality checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Some quality checks failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # RUST UNIT TESTS: Fast, isolated Rust tests
  # =============================================================================
  rust-unit-tests:
    name: Rust Unit Tests - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
          - platform: macos
            os: macos-latest
          - platform: windows
            os: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      # Install Linux dependencies for testing
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libwayland-dev \
            libxkbcommon-dev

      - name: Run Rust unit tests
        working-directory: src-tauri
        run: cargo test --lib --bins

      - name: Run Rust doc tests
        working-directory: src-tauri
        run: cargo test --doc

      - name: Test summary
        if: always()
        run: |
          echo "### Rust Unit Tests (${{ matrix.platform }}) :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo ":white_check_mark: All Rust unit tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Some Rust unit tests failed." >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

  # =============================================================================
  # TYPESCRIPT UNIT TESTS: Jest tests for TypeScript code
  # =============================================================================
  typescript-unit-tests:
    name: TypeScript Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run compile

      - name: Run Jest unit tests
        run: npm run test:tauri:unit
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jest-results
          path: |
            coverage/
            test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Test summary
        if: always()
        run: |
          echo "### TypeScript Unit Tests :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo ":white_check_mark: All TypeScript unit tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Some TypeScript unit tests failed." >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # INTEGRATION TESTS: IPC, window management, and cross-component tests
  # =============================================================================
  integration-tests:
    name: Integration Tests - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: [rust-quality, rust-unit-tests, typescript-unit-tests]

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
          - platform: macos
            os: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      # Install Linux dependencies
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libwayland-dev \
            libwayland-client0 \
            libwayland-server0 \
            libxkbcommon-dev \
            wayland-protocols \
            xwayland \
            weston

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run compile

      - name: Build Tauri (debug mode)
        run: cd src-tauri && cargo build

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Tauri integration tests
        run: npm run test:tauri:integration
        timeout-minutes: 15

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-results-${{ matrix.platform }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Test summary
        if: always()
        run: |
          echo "### Integration Tests (${{ matrix.platform }}) :gear:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo ":white_check_mark: All integration tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Some integration tests failed." >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

  # =============================================================================
  # E2E TESTS: Full application end-to-end tests with Playwright
  # =============================================================================
  e2e-tests:
    name: E2E Tests - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: [rust-quality, rust-unit-tests, typescript-unit-tests]

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
          - platform: macos
            os: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      # Install Linux dependencies
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libwayland-dev \
            libwayland-client0 \
            libwayland-server0 \
            libxkbcommon-dev \
            wayland-protocols \
            xwayland \
            weston

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run compile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npm run test:tauri:e2e
        timeout-minutes: 20

      - name: Upload E2E results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ matrix.platform }}
          path: |
            test-results/
            playwright-report/
            screenshots/
            videos/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.platform }}
          path: playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Test summary
        if: always()
        run: |
          echo "### E2E Tests (${{ matrix.platform }}) :computer:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo ":white_check_mark: All E2E tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Some E2E tests failed. Check the Playwright report for details." >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

  # =============================================================================
  # FEATURE PARITY TESTS: Ensure Tauri matches expected behavior
  # =============================================================================
  feature-parity-tests:
    name: Feature Parity Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libwayland-dev \
            libxkbcommon-dev

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run compile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run feature parity tests
        run: npm run test:tauri:feature-parity
        timeout-minutes: 15

      - name: Upload feature parity results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: feature-parity-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Test summary
        if: always()
        run: |
          echo "### Feature Parity Tests :balance_scale:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo ":white_check_mark: All feature parity tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Some features don't match expected behavior." >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # PERFORMANCE TESTS: Benchmark startup time, memory usage, bundle size
  # =============================================================================
  performance-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [integration-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libwayland-dev \
            libxkbcommon-dev

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run compile

      - name: Build Tauri (release mode)
        run: cd src-tauri && cargo build --release

      - name: Run performance benchmarks
        run: npm run test:tauri:performance
        continue-on-error: true

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            performance-results/
            benchmarks/
          retention-days: 30
          if-no-files-found: ignore

      - name: Performance summary
        if: always()
        run: |
          echo "### Performance Benchmarks :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Performance benchmarks completed. Results uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Key Metrics:**" >> $GITHUB_STEP_SUMMARY
          echo "- Startup time: Check artifacts for details" >> $GITHUB_STEP_SUMMARY
          echo "- Memory usage: Check artifacts for details" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle size: Check artifacts for details" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # TEST REPORT: Aggregate all test results and generate summary
  # =============================================================================
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [rust-quality, rust-unit-tests, typescript-unit-tests, integration-tests, e2e-tests, feature-parity-tests, performance-tests]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-artifacts

      - name: Display test artifacts
        run: ls -R test-artifacts || echo "No artifacts found"

      - name: Generate test summary
        run: |
          echo "# Tauri Test Suite Results :clipboard:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Quality | ${{ needs.rust-quality.result == 'success' && ':white_check_mark:' || ':x:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Unit Tests | ${{ needs.rust-unit-tests.result == 'success' && ':white_check_mark:' || ':x:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript Unit Tests | ${{ needs.typescript-unit-tests.result == 'success' && ':white_check_mark:' || ':x:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result == 'success' && ':white_check_mark:' || ':x:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && ':white_check_mark:' || ':x:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Feature Parity | ${{ needs.feature-parity-tests.result == 'success' && ':white_check_mark:' || ':x:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance-tests.result == 'success' && ':white_check_mark:' || ':x:' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.rust-quality.result }}" == "success" ] && \
             [ "${{ needs.rust-unit-tests.result }}" == "success" ] && \
             [ "${{ needs.typescript-unit-tests.result }}" == "success" ] && \
             [ "${{ needs.integration-tests.result }}" == "success" ] && \
             [ "${{ needs.e2e-tests.result }}" == "success" ] && \
             [ "${{ needs.feature-parity-tests.result }}" == "success" ]; then
            echo ":white_check_mark: **All critical tests passed!** The build is ready for release." >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: **Some tests failed.** Please review the logs and fix issues before merging." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Review test artifacts for detailed results" >> $GITHUB_STEP_SUMMARY
          echo "- Check Playwright reports for E2E test details" >> $GITHUB_STEP_SUMMARY
          echo "- Review performance benchmarks" >> $GITHUB_STEP_SUMMARY
          echo "- Fix any failing tests before merging" >> $GITHUB_STEP_SUMMARY
